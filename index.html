<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìì‚° ê´€ë¦¬ ì‹œìŠ¤í…œ (P.A.M.S)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
        window.supabaseCreateClient = createClient;
    </script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap">
    <style>
        :host, body, html { font-family: 'Inter', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        select, input[type="text"], input[type="date"], input[type="number"], textarea {
            @apply mt-1 block w-full border border-slate-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500;
        }
        progress { @apply w-full h-2 rounded-full overflow-hidden; }
        progress::-webkit-progress-bar { @apply bg-slate-200; }
        progress::-webkit-progress-value { @apply bg-indigo-600 transition-all duration-500; }
        progress.warning::-webkit-progress-value { @apply bg-yellow-500; }
        progress.danger::-webkit-progress-value { @apply bg-red-500; }
    </style>
</head>
<body class="bg-slate-100">

    <div id="app-root">
        <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="flex flex-col items-center p-6 bg-white rounded-lg shadow-2xl">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mb-3"></div>
                <p id="loading-text" class="text-lg font-semibold text-gray-700">ì²˜ë¦¬ ì¤‘...</p>
            </div>
        </div>

        <div class="flex h-screen bg-slate-100">
            <nav class="w-64 bg-slate-800 text-white flex flex-col fixed h-full z-30 shadow-lg">
                <div class="px-6 py-5 border-b border-slate-700">
                    <h2 class="text-2xl font-bold text-indigo-400">P.A.M.S</h2>
                    <span class="text-xs text-slate-400">Product Asset Mgmt System</span>
                </div>
                <ul class="flex-1 py-4 space-y-2">
                    <li class="px-4"><button id="nav-dashboard" class="w-full flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 bg-indigo-600 transition-colors">ğŸ“Š í˜„í™© ëª¨ë‹ˆí„°ë§</button></li>
                    <li class="px-4"><button id="nav-assets" class="w-full flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors">ğŸ–¥ï¸ ìì‚° ë§ˆìŠ¤í„°</button></li>
                    <li class="px-4"><button id="nav-consumption" class="w-full flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors">ğŸ“‰ ì†Œëª¨/ë°˜í™˜ í˜„í™©</button></li>
                    <li class="px-4"><button id="nav-lifecycle" class="w-full flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors">ğŸ”„ íšŸìˆ˜ ìˆ˜ëª… ê´€ë¦¬</button></li>
                    <li class="px-4"><button id="nav-settings" class="w-full flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors">âš™ï¸ ì„¤ì •</button></li>
                </ul>
                <div class="px-6 py-4 border-t border-slate-700 text-xs text-slate-400">
                    <p id="connection-status">Connecting...</p>
                </div>
            </nav>

            <main class="flex-1 ml-64 p-8 overflow-y-auto">
                
                <div id="view-dashboard" class="view-content animate-fade-in">
                    <h1 class="text-3xl font-extrabold text-slate-800 mb-6">í˜„í™© ëª¨ë‹ˆí„°ë§</h1>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow border-b-4 border-indigo-500">
                            <p class="text-sm font-medium text-slate-500">ì´ ë“±ë¡ ìì‚° (Master)</p>
                            <p id="kpi-total-assets" class="text-4xl font-extrabold text-slate-900 mt-2">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow border-b-4 border-green-500">
                            <p class="text-sm font-medium text-slate-500">í˜„ì¬ ì´ ì¬ê³ ëŸ‰ (Stock)</p>
                            <p id="kpi-total-stock" class="text-4xl font-extrabold text-slate-900 mt-2">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow border-b-4 border-red-500">
                            <p class="text-sm font-medium text-slate-500">ğŸš¨ ì¡°ì¹˜ í•„ìš” í•­ëª©</p>
                            <p id="kpi-action-required" class="text-4xl font-extrabold text-red-600 mt-2">0</p>
                        </div>
                    </div>

                    <div id="alert-section" class="hidden mb-8">
                        <h2 class="text-xl font-bold text-red-600 flex items-center mb-4">
                            <span class="mr-2">ğŸš¨</span> ê¸´ê¸‰ ì¡°ì¹˜ í•„ìš” í•­ëª©
                        </h2>
                        <div id="alert-list" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow">
                            <h3 class="text-xl font-semibold mb-5 text-slate-800 border-b pb-3">ğŸ“¦ ì°½ê³ ë³„ ì¬ê³  í˜„í™©</h3>
                            <div id="stock-by-warehouse-container" class="space-y-4">
                                </div>
                        </div>

                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow">
                            <h3 class="text-xl font-semibold mb-5 text-slate-800 border-b pb-3">âš¡ ìµœê·¼ í™œë™ (Top 5)</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-slate-200">
                                    <thead class="bg-slate-50">
                                        <tr><th class="p-3 text-left">ì²˜ë¦¬</th><th class="p-3 text-left">ì½”ë“œ</th><th class="p-3 text-left">ì‹œë¦¬ì–¼</th><th class="p-3 text-right">ìˆ˜ëŸ‰</th><th class="p-3 text-left">ì‹œê°„</th></tr>
                                    </thead>
                                    <tbody id="dashboard-history-table" class="divide-y divide-slate-200">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow mb-8">
                        <h3 class="text-xl font-semibold mb-5 text-slate-800 border-b pb-3">ğŸ“Š ìì¬ ìœ í˜•ë³„ ë§ˆìŠ¤í„° í˜„í™©</h3>
                        <div id="type-breakdown-container" class="grid grid-cols-2 md:grid-cols-5 gap-4"></div>
                    </div>
                </div>

                <div id="view-assets" class="view-content animate-fade-in hidden">
                    <h1 class="text-3xl font-extrabold text-slate-800 mb-6">ìì‚° ë§ˆìŠ¤í„° ê´€ë¦¬</h1>
                    <div class="flex justify-between items-center p-4 bg-white rounded-xl shadow mb-8">
                        <button id="open-asset-modal-new" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow hover:bg-indigo-700 transition">+ ìƒˆ ìì‚° ë“±ë¡</button>
                        <div class="flex space-x-3 opacity-50 cursor-not-allowed">
                            <label class="px-6 py-3 bg-slate-200 text-slate-800 font-semibold rounded-lg">ğŸ“¤ ì—‘ì…€ ì—…ë¡œë“œ</label>
                            <button class="px-6 py-3 bg-slate-200 text-slate-800 font-semibold rounded-lg">â¬‡ï¸ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                        </div>
                    </div>
                    <div id="asset-list" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
                </div>

                <div id="view-consumption" class="view-content animate-fade-in hidden">
                    <h1 class="text-3xl font-extrabold text-slate-800 mb-6">ì¼ì¼ ì†Œëª¨/ë°˜í™˜ í˜„í™©</h1>
                    <div class="bg-white p-6 rounded-xl shadow mb-8">
                        <h3 class="text-xl font-semibold mb-5 text-slate-800 border-b pb-3">ì¬ê³  ìˆ˜ê¸° ì²˜ë¦¬</h3>
                        <form id="consumption-form" class="space-y-4">
                            <div class="grid grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">ìì‚° ì½”ë“œ (product_code) *</label>
                                    <select name="product_code" id="cons-pcode" required class="font-mono"><option value="">ìì‚° ì„ íƒ...</option></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">ì‹œë¦¬ì–¼ (serial / ì°½ê³ ) *</label>
                                    <select name="serial_number" id="cons-serial" required class="font-mono"><option value="">ë¨¼ì € ìì‚° ì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option></select>
                                </div>
                                <input type="hidden" name="wh_code" id="cons-wh-code">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">ìˆ˜ëŸ‰ (qty) *</label>
                                    <input type="number" name="qty" required min="1" value="1">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">ì²˜ë¦¬ (tran_code) *</label>
                                    <select name="tran_code">
                                        <option value="CONSUME">ì†Œëª¨ (ì¶œê³ )</option>
                                        <option value="ROLLBACK">ë°˜í™˜ (ì…ê³ )</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex justify-end pt-3">
                                <button type="submit" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">ì²˜ë¦¬ ë“±ë¡</button>
                            </div>
                        </form>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="text-xl font-semibold mb-5 text-slate-800 border-b pb-3">ìµœê·¼ ì²˜ë¦¬ ì´ë ¥ (Top 20)</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr><th class="p-3 text-left">ì²˜ë¦¬</th><th class="p-3 text-left">ì½”ë“œ</th><th class="p-3 text-left">ì‹œë¦¬ì–¼</th><th class="p-3 text-right">ìˆ˜ëŸ‰</th><th class="p-3 text-left">ì‹œê°„</th></tr>
                                </thead>
                                <tbody id="recent-lot-history-table" class="divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="view-lifecycle" class="view-content animate-fade-in hidden">
                    <h1 class="text-3xl font-extrabold text-slate-800 mb-6">íšŸìˆ˜ ìˆ˜ëª… ê´€ë¦¬</h1>
                    <div class="bg-white p-6 rounded-xl shadow mb-8">
                        <div class="flex justify-between items-center mb-5 border-b pb-3">
                            <h3 class="text-xl font-semibold text-slate-800">ì‚¬ìš© íšŸìˆ˜(COUNT) ê´€ë¦¬ ëŒ€ìƒ</h3>
                            <p class="text-sm text-slate-500">ğŸ’¡ '1íšŒ ì‚¬ìš©' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì‚¬ìš© íšŸìˆ˜ê°€ ì¦ê°€í•˜ê³  ìˆ˜ëª… ê²Œì´ì§€ê°€ ì°¹ë‹ˆë‹¤.</p>
                        </div>
                        <div id="lifecycle-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </div>
                </div>

                <div id="view-settings" class="view-content animate-fade-in hidden">
                    <h1 class="text-3xl font-extrabold text-slate-800 mb-6">ì„¤ì •</h1>
                    <div class="bg-white p-8 rounded-xl shadow max-w-xl">
                        <label class="block text-sm font-medium text-slate-700">ê´€ë¦¬ì ID / ì´ë¦„ (í•„ìˆ˜)</label>
                        <input type="text" id="managerIdInput" placeholder="ì˜ˆ: HONG-001" class="mt-1 block w-full border border-slate-300 rounded-lg p-3">
                        <p class="text-sm text-slate-500 mt-2">* ëª¨ë“  íŠ¸ëœì­ì…˜ ê¸°ë¡ì— ì´ IDê°€ ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </main>
        </div>

        <div id="asset-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4 z-40 hidden">
            <div class="bg-white rounded-xl w-full max-w-4xl p-8 overflow-y-auto max-h-[90vh]">
                <h3 class="text-2xl font-bold text-slate-800 mb-6 border-b pb-3">ìƒˆ ìì‚° ë“±ë¡</h3>
                <form id="asset-form">
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div class="col-span-2 grid grid-cols-2 gap-6 p-4 bg-indigo-50 rounded-xl">
                            <div><label class="block text-sm font-medium text-indigo-900">ê³µì¥ (factory_id) *</label>
                                <select name="factory_id" required class="border-indigo-300">
                                    <option value="USB">USB (ìš¸ì‚° ì „ë™í™” ê³µì¥)</option>
                                    <option value="PST">PST (í‰íƒ ì‹œì‘ì‹¤)</option>
                                    <option value="HLB">HLB (í™”ì„± ì—°êµ¬ì†Œ)</option>
                                </select>
                            </div>
                            <div><label class="block text-sm font-medium text-indigo-900">ì°½ê³  (wh_code) *</label>
                                <select name="wh_code" required class="border-indigo-300">
                                    <option value="OW">OW (ì‚¬ë¬´ì°½ê³ )</option>
                                    <option value="FW">FW (ê³µì¥ì°½ê³ )</option>
                                    <option value="LW">LW (ì—°êµ¬ì‹¤ì°½ê³ )</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-span-2"><label class="block text-sm font-medium text-slate-700">ìì‚°ëª… (product_name) *</label><input type="text" name="product_name" required placeholder="ì˜ˆ: ì „ë™ ë“œë¼ì´ë²„ A-Type"></div>
                        <div><label class="block text-sm font-medium text-slate-700">ìì‚° ì½”ë“œ (product_code) *</label><input type="text" name="product_code" required placeholder="ì˜ˆ: TOL-DRV-001"></div>
                        <div><label class="block text-sm font-medium text-slate-700">êµ¬ë§¤ì¼ *</label><input type="date" name="purchase_date" required></div>
                        
                        <div><label class="block text-sm font-medium text-slate-700">ìì‚° ëŒ€ë¶„ë¥˜ (cmf_1) *</label>
                            <select name="cmf_1" required>
                                <option value="">ì„ íƒ...</option>
                                <option value="M">M (ëª¨ë¹„ìŠ¤)</option>
                                <option value="B">B (NBTS)</option>
                                <option value="K">K (NVHK)</option>
                                <option value="H">H (í™”ì„± ì—°êµ¬ì†Œ)</option>
                                <option value="S">S (í‰íƒ ì‹œì‘ì‹¤)</option>
                            </select>
                        </div>
                        
                        <div><label class="block text-sm font-medium text-slate-700">ìƒì„¸ ìœ í˜• (product_type) *</label>
                            <select name="product_type" required>
                                <option value="">ì„ íƒ...</option>
                                <option value="ë³´ì „ ìì¬">ë³´ì „ ìì¬ (EMM)</option>
                                <option value="ì»´í“¨í„°/ë…¸íŠ¸ë¶">ì»´í“¨í„°/ë…¸íŠ¸ë¶ (COM)</option>
                                <option value="ì„œë²„">ì„œë²„ (SVR)</option>
                                <option value="ë„êµ¬">ë„êµ¬ (TOL)</option>
                                <option value="ì†Œëª¨ì„± ìì¬">ì†Œëª¨ì„± ìì¬ (CSM)</option>
                                <option value="ê¸°íƒ€">ê¸°íƒ€ (ETC)</option>
                            </select>
                        </div>

                        <div><label class="block text-sm font-medium text-slate-700">ì‚¬ìš© ë¶€ì„œ (dept) *</label>
                            <select name="dept" required>
                                <option value="">ì„ íƒ...</option>
                                <option value="ICT ê¸°íšíŒ€">ICT ê¸°íšíŒ€ (ICT)</option>
                                <option value="íšŒê³„íŒ€">íšŒê³„íŒ€ (ACC)</option>
                                <option value="ì¬ë¬´íŒ€">ì¬ë¬´íŒ€ (FIN)</option>
                                <option value="ì¸ì‚¬ë…¸ë¬´íŒ€">ì¸ì‚¬ë…¸ë¬´íŒ€ (HR)</option>
                                <option value="ì´ë¬´íŒ€">ì´ë¬´íŒ€ (GA)</option>
                                <option value="ì•ˆì „í™˜ê²½ì‹¤">ì•ˆì „í™˜ê²½ì‹¤ (SAF)</option>
                                <option value="ESG TFT">ESG TFT (ESG)</option>
                                <option value="ì„ í–‰í’ˆì§ˆì‹œí—˜íŒ€">ì„ í–‰í’ˆì§ˆì‹œí—˜íŒ€ (AQT)</option>
                                <option value="ì‹ ì°¨í’ˆì§ˆíŒ€">ì‹ ì°¨í’ˆì§ˆíŒ€ (NQ)</option>
                                <option value="í’ˆì§ˆê²½ì˜íŒ€">í’ˆì§ˆê²½ì˜íŒ€ (QM)</option>
                                <option value="ì „ë™í™”í’ˆì§ˆíŒ€">ì „ë™í™”í’ˆì§ˆíŒ€ (EQ)</option>
                                <option value="êµ¬ë§¤íŒ€">êµ¬ë§¤íŒ€ (PUR)</option>
                                <option value="ê°œë°œíŒ€">ê°œë°œíŒ€ (DEV)</option>
                                <option value="ìƒì‚°ê¸°ìˆ íŒ€">ìƒì‚°ê¸°ìˆ íŒ€ (PT)</option>
                                <option value="ê¸°ìˆ ê°œë°œì„¼í„°">ê¸°ìˆ ê°œë°œì„¼í„° (TDC)</option>
                                <option value="ì „ë™í™”ì„¤ê³„íŒ€">ì „ë™í™”ì„¤ê³„íŒ€ (ED)</option>
                                <option value="ì˜ì—…êµ¬ë§¤1íŒ€">ì˜ì—…êµ¬ë§¤1íŒ€ (BP1)</option>
                                <option value="ì˜ì—…êµ¬ë§¤2íŒ€">ì˜ì—…êµ¬ë§¤2íŒ€ (BP2)</option>
                                <option value="ìƒì‚°ê´€ë¦¬íŒ€">ìƒì‚°ê´€ë¦¬íŒ€ (PM)</option>
                                <option value="ìƒì‚°íŒ€">ìƒì‚°íŒ€ (PRO)</option>
                                <option value="ê³µì •ê¸°ìˆ íŒ€">ê³µì •ê¸°ìˆ íŒ€ (OT)</option>
                            </select>
                        </div>

                        <div class="col-span-2 grid grid-cols-2 gap-6 p-4 bg-slate-100 rounded-xl border border-slate-200">
                            <h4 class="col-span-2 text-sm font-bold text-slate-700 mb-[-10px]">ì œí’ˆ ìˆ˜ëª… ì£¼ê¸° ê´€ë¦¬ (Product Life Cycle)</h4>
                            <div>
                                <label class="block text-sm font-medium text-slate-700">ê´€ë¦¬ ìœ í˜• (cmf_3)</label>
                                <select name="cmf_3" id="lifecycle-type">
                                    <option value="NONE" selected>ì‚¬ìš© ì•ˆí•¨ (ì¼ë°˜ ìì¬)</option>
                                    <option value="PERIOD">ì£¼ê¸° ê´€ë¦¬ (ê°œì›” ë‹¨ìœ„)</option>
                                    <option value="COUNT">íšŸìˆ˜ ê´€ë¦¬ (ì‚¬ìš© íšŸìˆ˜)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700">ì„¤ì • ê°’ (cmf_4)</label>
                                <input type="number" name="cmf_4" id="lifecycle-value" min="1" placeholder="ìœ í˜• ì„ íƒ í›„ ì…ë ¥" disabled class="bg-gray-200 cursor-not-allowed">
                            </div>
                        </div>

                        <div><label class="block text-sm font-medium text-slate-700 bg-gray-50 p-1 rounded">ë‚´ë¶€ ê´€ë¦¬ ì½”ë“œ (ìë™ìƒì„±)</label><input type="text" name="cmf_2" readonly class="bg-gray-100 text-slate-500 cursor-not-allowed" placeholder="ì €ì¥ ì‹œ ìë™ ìƒì„±ë¨"></div>

                        <div><label class="block text-sm font-medium text-slate-700">ì‹œë¦¬ì–¼ ë²ˆí˜¸ (ì„ íƒ)</label><input type="text" name="serial_number" placeholder="ì—†ì„ ê²½ìš° ë¹„ì›Œë‘ì„¸ìš”"></div>
                        <div><label class="block text-sm font-medium text-slate-700">ì‹¤ì‚¬ìš©ì (ì„ íƒ)</label><input type="text" name="user" placeholder="ì˜ˆ: í™ê¸¸ë™"></div>
                        
                        <div><label class="block text-sm font-medium text-slate-700">ì´ˆê¸° ìˆ˜ëŸ‰ (qty) *</label><input type="number" name="qty" min="0" value="1" required></div>
                        <div><label class="block text-sm font-medium text-slate-700">ì•ˆì „ ì¬ê³  (safe_qty)</label><input type="number" name="safe_qty" min="0" value="0"></div>
                        
                        <div><label class="block text-sm font-medium text-slate-700">ë‹¨ìœ„ (unit) *</label>
                            <select name="unit" required>
                                <option value="EA" selected>EA (ê°œ)</option>
                                <option value="BOX">BOX (ë°•ìŠ¤)</option>
                                <option value="SET">SET (ì„¸íŠ¸)</option>
                                <option value="Kg">Kg (í‚¬ë¡œê·¸ë¨)</option>
                                <option value="L">L (ë¦¬í„°)</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 border-t pt-4">
                        <button type="button" id="close-asset-modal" class="px-5 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition">ì·¨ì†Œ</button>
                        <button type="submit" class="px-5 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition shadow-md">ì €ì¥ í•˜ê¸°</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://xtcoovvghttnwxwdttqa.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh0Y29vdnZnaHR0bnd4d2R0dHFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMDE3NzYsImV4cCI6MjA3Njg3Nzc3Nn0.Fmn9b1FoyklF5jw0oiLKp4JT1zRTY9iq9hiCog6HHpE';
        const createClient = window.supabaseCreateClient;
        let supabase;

        // ì „ì—­ ìƒíƒœ ê´€ë¦¬
        const state = { 
            assets: [],      // MA_PRODUCT ë§ˆìŠ¤í„° ë°ì´í„°
            history: [],     // ìµœê·¼ 20ê±´ íŠ¸ëœì­ì…˜ ì´ë ¥
            stock: [],       // WH_STS í˜„ì¬ ì¬ê³  ë°ì´í„°
            usageCounts: {}, // 'COUNT' íƒ€ì… ìì‚°ì˜ ì´ ì‚¬ìš© íšŸìˆ˜ ìºì‹œ { "code|serial": count }
            managerId: localStorage.getItem('mgrId') || '' 
        };
        
        // ë§¤í•‘ ìƒìˆ˜
        const TYPE_MAP = { "ë³´ì „ ìì¬": "EMM", "ì»´í“¨í„°/ë…¸íŠ¸ë¶": "COM", "ì„œë²„": "SVR", "ë„êµ¬": "TOL", "ì†Œëª¨ì„± ìì¬": "CSM", "ê¸°íƒ€": "ETC" };
        const DEPT_MAP = { "ICT ê¸°íšíŒ€": "ICT", "íšŒê³„íŒ€": "ACC", "ì¬ë¬´íŒ€": "FIN", "ì¸ì‚¬ë…¸ë¬´íŒ€": "HR", "ì´ë¬´íŒ€": "GA", "ì•ˆì „í™˜ê²½ì‹¤": "SAF", "ESG TFT": "ESG", "ì„ í–‰í’ˆì§ˆì‹œí—˜íŒ€": "AQT", "ì‹ ì°¨í’ˆì§ˆíŒ€": "NQ", "í’ˆì§ˆê²½ì˜íŒ€": "QM", "ì „ë™í™”í’ˆì§ˆíŒ€": "EQ", "êµ¬ë§¤íŒ€": "PUR", "ê°œë°œíŒ€": "DEV", "ìƒì‚°ê¸°ìˆ íŒ€": "PT", "ê¸°ìˆ ê°œë°œì„¼í„°": "TDC", "ì „ë™í™”ì„¤ê³„íŒ€": "ED", "ì˜ì—…êµ¬ë§¤1íŒ€": "BP1", "ì˜ì—…êµ¬ë§¤2íŒ€": "BP2", "ìƒì‚°ê´€ë¦¬íŒ€": "PM", "ìƒì‚°íŒ€": "PRO", "ê³µì •ê¸°ìˆ íŒ€": "OT" };
        const MONTH_MAP = ['A','B','C','D','E','F','G','H','I','J','K','L'];

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        const $ = s => document.querySelector(s);
        const showLoading = (show, msg='ì²˜ë¦¬ ì¤‘...') => { $('#loading-text').innerText=msg; $('#loading-overlay').classList.toggle('hidden', !show); };
        const alertMsg = (msg, err=false) => { alert(msg); if(err) console.error(msg); };

        // ì´ˆê¸°í™”
        async function init() {
            showLoading(true, 'ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...');
            try {
                supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
                if(state.managerId) $('#managerIdInput').value = state.managerId;
                
                await loadData(); // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
                subscribe();      // ì‹¤ì‹œê°„ êµ¬ë… ì‹œì‘
                bindEvents();     // ì´ë²¤íŠ¸ ë°”ì¸ë”©

                $('#connection-status').innerText = 'ğŸŸ¢ Connected (Realtime)';
            } catch(e) {
                $('#connection-status').innerText = 'ğŸ”´ Connection Failed'; 
                alertMsg('ì´ˆê¸°í™” ì‹¤íŒ¨: '+e.message, true);
            } finally { showLoading(false); }
        }

        function bindEvents() {
            // ë„¤ë¹„ê²Œì´ì…˜ í´ë¦­ ì´ë²¤íŠ¸
            ['dashboard','assets','consumption','lifecycle','settings'].forEach(v => $('#nav-'+v).onclick = () => changeView('view-'+v));
            
            // ì„¤ì • ë° ëª¨ë‹¬ ì´ë²¤íŠ¸
            $('#managerIdInput').oninput = e => { state.managerId=e.target.value; localStorage.setItem('mgrId', e.target.value); };
            $('#open-asset-modal-new').onclick = () => $('#asset-modal').classList.remove('hidden');
            $('#close-asset-modal').onclick = () => { $('#asset-modal').classList.add('hidden'); $('#asset-form').reset(); resetLifecycleInputs(); };
            
            // í¼ ì œì¶œ ì´ë²¤íŠ¸
            $('#asset-form').onsubmit = saveAsset;
            $('#consumption-form').onsubmit = saveConsumption;
            
            // ì†Œëª¨í’ˆ ì²˜ë¦¬ ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì´ë²¤íŠ¸
            $('#cons-pcode').onchange = handleProductChange;
            $('#cons-serial').onchange = handleSerialChange;
            
            // ìˆ˜ëª… ì£¼ê¸° íƒ€ì… ë³€ê²½ ì‹œ ì…ë ¥ í•„ë“œ í™œì„±/ë¹„í™œì„± ì²˜ë¦¬
            $('#lifecycle-type').onchange = (e) => {
                const valInput = $('#lifecycle-value');
                if (e.target.value === 'NONE') { 
                    valInput.disabled = true; valInput.value = ''; 
                    valInput.classList.add('bg-gray-200', 'cursor-not-allowed');
                    valInput.classList.remove('bg-white');
                } else { 
                    valInput.disabled = false; 
                    valInput.classList.remove('bg-gray-200', 'cursor-not-allowed');
                    valInput.classList.add('bg-white');
                    valInput.focus(); 
                }
            };
            
            // [Lifecycle] '1íšŒ ì‚¬ìš©' ë²„íŠ¼ ì´ë²¤íŠ¸ ìœ„ì„
            $('#lifecycle-list').addEventListener('click', async (e) => {
                if (e.target.classList.contains('use-btn')) {
                    await handleUseAsset(e.target.getAttribute('data-pcode'), e.target.getAttribute('data-sn'));
                }
            });
        }

        function resetLifecycleInputs() {
             const valInput = $('#lifecycle-value');
             valInput.disabled = true; valInput.value = '';
             valInput.classList.add('bg-gray-200', 'cursor-not-allowed');
        }

        function changeView(id) {
            document.querySelectorAll('.view-content').forEach(el => el.classList.add('hidden'));
            $('#'+id).classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('bg-indigo-600'));
            $('#nav-'+id.replace('view-','')).classList.add('bg-indigo-600');
            
            // ë·° ì§„ì… ì‹œ íŠ¹ì • ë™ì‘ ìˆ˜í–‰
            if(id === 'view-dashboard') render(); // ëŒ€ì‹œë³´ë“œ ê°±ì‹ 
            if(id === 'view-consumption') updateConsumptionDropdowns();
            if(id === 'view-lifecycle') renderLifecycle();
        }

        async function loadData() {
            // Promise.allë¡œ ë³‘ë ¬ ë°ì´í„° ë¡œë“œ
            const [rMaster, rHistoryTop, rStock, rUseHistory] = await Promise.all([
                supabase.from('MA_PRODUCT').select('*').order('created_at', { ascending: false }),
                supabase.from('LOT_HIS').select('*').order('created_at', { ascending: false }).limit(20),
                supabase.from('WH_STS').select('*'),
                supabase.from('LOT_HIS').select('product_code, serial_number, qty').eq('tran_code', 'USE')
            ]);

            if(rMaster.error) throw rMaster.error;
            state.assets = rMaster.data;
            state.history = rHistoryTop.data || [];
            state.stock = rStock.data || [];

            // ì‚¬ìš© íšŸìˆ˜ ì „ì—­ ì§‘ê³„ (ìºì‹±)
            state.usageCounts = {};
            if (rUseHistory.data) {
                rUseHistory.data.forEach(h => {
                    const key = `${h.product_code}|${h.serial_number||'null'}`;
                    state.usageCounts[key] = (state.usageCounts[key] || 0) + (h.qty || 0);
                });
            }

            render(); // ë°ì´í„° ë¡œë“œ í›„ í™”ë©´ ê°±ì‹ 
        }

        function subscribe() {
            // DB ë³€ê²½ ì‚¬í•­ ì‹¤ì‹œê°„ ê°ì§€
            supabase.channel('public:all').on('postgres_changes', { event: '*', schema: 'public' }, () => loadData()).subscribe();
        }

        // =========================================
        // [í•µì‹¬] ë Œë”ë§ ê´€ë ¨ í•¨ìˆ˜ë“¤ (ëŒ€ì‹œë³´ë“œ ê°œì„ )
        // =========================================
        function render() {
            $('#kpi-total-assets').innerText = state.assets.length.toLocaleString();
            $('#kpi-total-stock').innerText = state.stock.reduce((sum, i) => sum + i.qty, 0).toLocaleString();
            
            renderSafetyAlerts();       // [MODIFIED] ì•ˆì „ì¬ê³  í˜„í™© + KPI ì—…ë°ì´íŠ¸
            renderAssets();             // ìì‚° ë§ˆìŠ¤í„° ë¦¬ìŠ¤íŠ¸
            renderHistory();            // (ì†Œëª¨/ë°˜í™˜ íƒ­) ìµœê·¼ ì´ë ¥ í…Œì´ë¸”
            renderTypeBreakdown();      // (ëŒ€ì‹œë³´ë“œ) ìœ í˜•ë³„ í†µê³„
            renderStockByWarehouse();   // [NEW] (ëŒ€ì‹œë³´ë“œ) ì°½ê³ ë³„ ì¬ê³ 
            renderDashboardHistory();   // [NEW] (ëŒ€ì‹œë³´ë“œ) ìµœê·¼ í™œë™ ìš”ì•½
        }

        // [MODIFIED] ì•ˆì „ì¬ê³  ë° ë¦¬ìŠ¤í¬ ë¶„ì„ + KPI ì—…ë°ì´íŠ¸
        function renderSafetyAlerts() {
            const alerts = [];
            const today = new Date();

            state.stock.forEach(item => {
                const assetName = state.assets.find(a => a.product_code === item.product_code)?.product_name || item.product_code;
                const identifier = `${assetName} (${item.product_code})${item.serial_number ? ' [SN:'+item.serial_number+']' : ''}`;

                // 1. ì¼ë°˜ ì•ˆì „ì¬ê³  ë¶€ì¡± (NONE or null)
                if (!item.cmf_3 || item.cmf_3 === 'NONE') {
                    if (item.safe_qty > 0 && item.qty <= item.safe_qty) {
                        alerts.push({
                            type: 'ğŸ“¦ ì¬ê³  ë¶€ì¡±',
                            level: 'danger', 
                            msg: `<span class="font-bold">${identifier}</span>ì˜ ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í˜„ì¬: ${item.qty} / ì•ˆì „: ${item.safe_qty})`
                        });
                    }
                }
                // 2. ì£¼ê¸°(PERIOD) ë„ë˜
                else if (item.cmf_3 === 'PERIOD') {
                    const created = new Date(item.created_at);
                    const monthsPassed = (today.getFullYear() - created.getFullYear()) * 12 + (today.getMonth() - created.getMonth());
                    const limit = parseInt(item.cmf_4 || '0');
                    if (limit > 0 && monthsPassed >= limit) {
                        alerts.push({
                            type: 'ğŸ“… êµì²´ ì£¼ê¸° ë„ë˜',
                            level: 'warning', 
                            msg: `<span class="font-bold">${identifier}</span>ì˜ êµì²´ ì£¼ê¸°ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤. (ê²½ê³¼: ${monthsPassed}ê°œì›” / ì£¼ê¸°: ${limit}ê°œì›”)`
                        });
                    }
                }
                // 3. ì‚¬ìš© íšŸìˆ˜(COUNT) ì´ˆê³¼
                else if (item.cmf_3 === 'COUNT') {
                    const key = `${item.product_code}|${item.serial_number||'null'}`;
                    const used = state.usageCounts[key] || 0;
                    const limit = parseInt(item.cmf_4 || '0');
                    if (limit > 0 && used >= limit) {
                        alerts.push({
                            type: 'ğŸ”¢ ì‚¬ìš© í•œê³„ ë„ë‹¬',
                            level: 'warning', 
                            msg: `<span class="font-bold">${identifier}</span>ì˜ ì‚¬ìš© íšŸìˆ˜ê°€ í•œê³„ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤. (ì‚¬ìš©: ${used}íšŒ / í•œê³„: ${limit}íšŒ)`
                        });
                    }
                }
            });

            // [NEW] ì¡°ì¹˜ í•„ìš” KPI ì—…ë°ì´íŠ¸
            $('#kpi-action-required').innerText = alerts.length.toLocaleString();

            // ì•Œë¦¼ ì„¹ì…˜ í‘œì‹œ ì—¬ë¶€ ê²°ì •
            const alertSection = $('#alert-section');
            const alertList = $('#alert-list');
            
            if (alerts.length === 0) {
                alertSection.classList.add('hidden');
            } else {
                alertSection.classList.remove('hidden');
                alertList.innerHTML = alerts.map(a => `
                    <div class="flex items-start p-4 rounded-lg border-l-4 ${a.level === 'danger' ? 'bg-red-50 border-red-500 text-red-700' : 'bg-yellow-50 border-yellow-400 text-yellow-800'} shadow-sm">
                        <div class="flex-shrink-0 font-bold mr-3">${a.type}</div>
                        <div class="text-sm">${a.msg}</div>
                    </div>
                `).join('');
            }
        }

        // [NEW] ëŒ€ì‹œë³´ë“œ - ì°½ê³ ë³„ ì¬ê³  í˜„í™© ë Œë”ë§
        function renderStockByWarehouse() {
            const container = $('#stock-by-warehouse-container');
            const whStock = state.stock.reduce((acc, item) => {
                const wh = item.wh_code || 'ë¯¸ì§€ì •';
                acc[wh] = (acc[wh] || 0) + item.qty;
                return acc;
            }, {});

            if (Object.keys(whStock).length === 0) {
                container.innerHTML = '<p class="text-sm text-slate-500">ì¬ê³  ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            container.innerHTML = Object.entries(whStock)
                .sort((a, b) => b[1] - a[1]) // ìˆ˜ëŸ‰ ë§ì€ ìˆœ ì •ë ¬
                .map(([wh, qty]) => `
                <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg border border-slate-200">
                    <span class="font-semibold text-slate-700">${wh} ì°½ê³ </span>
                    <span class="font-bold text-indigo-600 text-lg">${qty.toLocaleString()} <span class="text-sm text-slate-400">ea</span></span>
                </div>
            `).join('');
        }

        // [NEW] ëŒ€ì‹œë³´ë“œ - ìµœê·¼ í™œë™ (Top 5) ë Œë”ë§
        function renderDashboardHistory() {
            const tableBody = $('#dashboard-history-table');
            const history = state.history.slice(0, 5); // Top 5
            
            if (history.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-slate-500">ìµœê·¼ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; 
                return; 
            }
            
            tableBody.innerHTML = history.map(h => {
                let { typeClass, typeName } = getHistoryType(h.tran_code);
                return `
                <tr class="hover:bg-slate-50 text-sm transition">
                    <td class="p-3 font-bold ${typeClass}">${typeName}</td>
                    <td class="p-3 font-mono">${h.product_code}</td>
                    <td class="p-3 text-slate-500 font-mono">${h.serial_number||'-'}</td>
                    <td class="p-3 font-bold text-right">${h.qty}</td>
                    <td class="p-3 text-slate-400 text-xs">${new Date(h.created_at).toLocaleString().slice(2)}</td>
                </tr>`;
            }).join('');
        }
        
        // [ë¶„ë¦¬] ì´ë ¥ í…Œì´ë¸” ë Œë”ë§ (ì†Œëª¨/ë°˜í™˜ íƒ­)
        function renderHistory() {
            const tableBody = $('#recent-lot-history-table');
            if (state.history.length === 0) { 
                tableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-slate-500">ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; 
                return; 
            }
            
            tableBody.innerHTML = state.history.map(h => {
                let { typeClass, typeName } = getHistoryType(h.tran_code);
                return `
                <tr class="hover:bg-slate-50 text-sm transition">
                    <td class="p-3 font-bold ${typeClass}">${typeName}</td>
                    <td class="p-3 font-mono">${h.product_code}</td>
                    <td class="p-3 text-slate-500 font-mono">${h.serial_number||'-'}</td>
                    <td class="p-3 font-bold text-right">${h.qty}</td>
                    <td class="p-3 text-slate-400 text-xs">${new Date(h.created_at).toLocaleString().slice(2)}</td>
                </tr>`;
            }).join('');
        }

        // [NEW] íŠ¸ëœì­ì…˜ ì½”ë“œ -> ì´ë¦„/í´ë˜ìŠ¤ ë³€í™˜ ìœ í‹¸
        function getHistoryType(tranCode) {
            let typeClass = 'text-slate-600', typeName = tranCode;
            switch(tranCode) {
                case 'IN': typeName='ì…ê³ '; typeClass='text-blue-600'; break;
                case 'CONSUME': typeName='ì†Œëª¨'; typeClass='text-red-600'; break;
                case 'ROLLBACK': typeName='ë°˜í™˜'; typeClass='text-green-600'; break;
                case 'USE': typeName='ì‚¬ìš©'; typeClass='text-purple-600'; break;
            }
            return { typeClass, typeName };
        }

        // =========================================
        // 
        //  (ìˆ˜ì • ì—†ìŒ) ê¸°ì¡´ í•¨ìˆ˜ë“¤
        // 
        // =========================================

        function renderLifecycle() {
            const list = $('#lifecycle-list');
            const countItems = state.stock.filter(s => s.cmf_3 === 'COUNT');
            
            if (countItems.length === 0) {
                list.innerHTML = '<div class="col-span-full p-10 text-center text-slate-500 bg-slate-50 rounded-xl border border-dashed">íšŸìˆ˜(COUNT)ë¡œ ê´€ë¦¬ë˜ëŠ” ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            list.innerHTML = countItems.map(item => {
                const asset = state.assets.find(a => a.product_code === item.product_code);
                const assetName = asset ? asset.product_name : item.product_code;
                const maxLife = parseInt(item.cmf_4 || '0');
                const currentUse = state.usageCounts[`${item.product_code}|${item.serial_number||'null'}`] || 0;
                const percent = maxLife > 0 ? Math.min((currentUse / maxLife) * 100, 100) : 0;
                
                let progressClass = '';
                if (percent >= 100) progressClass = 'danger';       // 100% ì´ìƒ ë¹¨ê°•
                else if (percent >= 80) progressClass = 'warning';  // 80% ì´ìƒ ë…¸ë‘

                return `
                <div class="bg-white p-6 rounded-xl shadow border border-slate-200 flex flex-col justify-between">
                    <div>
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-slate-800 truncate" title="${assetName}">${assetName}</h4>
                            <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800 whitespace-nowrap">íšŸìˆ˜ ê´€ë¦¬</span>
                        </div>
                        <div class="text-sm text-slate-600 space-y-1 mb-4">
                             <p>ì½”ë“œ: <span class="font-mono font-semibold">${item.product_code}</span></p>
                             <p>S/N: <span class="font-mono">${item.serial_number || '(No Serial)'}</span></p>
                        </div>
                        <div class="mb-4">
                            <div class="flex justify-between text-xs font-semibold mb-1">
                                <span>í˜„ì¬ ì‚¬ìš©: ${currentUse}íšŒ</span>
                                <span class="text-slate-400">ìµœëŒ€ ìˆ˜ëª…: ${maxLife}íšŒ</span>
                            </div>
                            <progress class="${progressClass} h-3" value="${percent}" max="100"></progress>
                        </div>
                    </div>
                    <button class="use-btn w-full py-3 bg-indigo-50 text-indigo-700 font-bold rounded-lg hover:bg-indigo-100 transition flex justify-center items-center" 
                            data-pcode="${item.product_code}" data-sn="${item.serial_number||''}">
                        âš¡ 1íšŒ ì‚¬ìš© ì²˜ë¦¬
                    </button>
                </div>`;
            }).join('');
        }

        async function handleUseAsset(pCode, sn) {
            if(!checkMgr()) return;
            const serialVal = sn === '' ? null : sn; 
            if(!confirm(`[ ${pCode} ] ìì‚°ì„ 1íšŒ ì‚¬ìš© ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            showLoading(true, 'ì‚¬ìš© ì²˜ë¦¬ ì¤‘...');
            try {
                const { error } = await supabase.from('LOT_HIS').insert({
                    tran_code: 'USE',
                    product_code: pCode,
                    serial_number: serialVal,
                    qty: 1,
                    create_user_id: state.managerId
                });
                if(error) throw error;
                // loadDataê°€ ìë™ìœ¼ë¡œ í˜¸ì¶œë˜ì–´(subscribe ë•ë¶„) í™”ë©´ì´ ê°±ì‹ ë©ë‹ˆë‹¤.
                alertMsg('ì‚¬ìš© ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch(e) {
                alertMsg('ì²˜ë¦¬ ì‹¤íŒ¨: ' + e.message, true);
            } finally { showLoading(false); }
        }

        function updateConsumptionDropdowns() {
            const pSelect = $('#cons-pcode');
            const currentVal = pSelect.value;
            const uniqueCodes = [...new Set(state.stock.map(s => s.product_code))].sort();
            
            pSelect.innerHTML = '<option value="">ìì‚° ì„ íƒ...</option>' + uniqueCodes.map(c => {
                const a = state.assets.find(ax => ax.product_code === c);
                return `<option value="${c}">${a ? a.product_name : c} (${c})</option>`;
            }).join('');
            
            if(currentVal && uniqueCodes.includes(currentVal)) pSelect.value = currentVal;
            handleProductChange();
        }

        function handleProductChange() {
            const pCode = $('#cons-pcode').value;
            const sSelect = $('#cons-serial');
            $('#cons-wh-code').value = '';
            sSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            
            if(!pCode) return;
            
            state.stock.filter(s => s.product_code === pCode).forEach(i => {
                const serialText = i.serial_number ? `S/N: ${i.serial_number}` : '(No Serial)';
                sSelect.innerHTML += `<option value="${i.serial_number||''}" data-wh="${i.wh_code}">${serialText} | ì°½ê³ : ${i.wh_code} | ì¬ê³ : ${i.qty}ea</option>`;
            });
        }

        function handleSerialChange(e) {
            $('#cons-wh-code').value = e.target.selectedOptions[0]?.getAttribute('data-wh') || '';
        }

        function renderAssets() {
            const list = $('#asset-list');
            if(!state.assets.length) { list.innerHTML='<div class="col-span-full p-10 text-center bg-white rounded-xl text-slate-500 border border-dashed">ë“±ë¡ëœ ìì‚° ë§ˆìŠ¤í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
            list.innerHTML = state.assets.map(a => `
                <div class="bg-white p-5 rounded-xl shadow-sm hover:shadow-md transition border border-slate-200">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-slate-800 truncate pr-2" title="${a.product_name}">${a.product_name}</h3>
                        <span class="px-2 py-1 text-xs font-medium rounded bg-slate-100 text-slate-600 whitespace-nowrap">${a.product_type}</span>
                    </div>
                    <div class="text-sm text-slate-600 space-y-1">
                        <p>ì½”ë“œ: <span class="font-mono font-semibold">${a.product_code}</span></p>
                        <p class="text-xs text-slate-400">ê´€ë¦¬ë²ˆí˜¸: ${a.cmf_2||'-'}</p>
                        <div class="flex justify-between items-center mt-3 pt-3 border-t">
                            <span class="text-xs text-slate-500">
                                ${a.cmf_3==='PERIOD' ? 'ğŸ“… ì£¼ê¸°: '+a.cmf_4+'ê°œì›”' : (a.cmf_3==='COUNT' ? 'ğŸ”¢ ìˆ˜ëª…: '+a.cmf_4+'íšŒ' : 'ğŸ“¦ ì¼ë°˜ ê´€ë¦¬')}
                            </span>
                            <span class="font-bold text-indigo-600">${a.qty} ${a.unit}</span>
                        </div>
                    </div>
                </div>`).join('');
        }

        function renderTypeBreakdown() {
            const counts = state.assets.reduce((acc, cur) => { acc[cur.product_type] = (acc[cur.product_type]||0)+1; return acc; }, {});
            $('#type-breakdown-container').innerHTML = Object.entries(counts).map(([type, count]) => `
                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-center">
                    <h4 class="text-xs font-bold text-indigo-400 mb-1 truncate uppercase">${type}</h4>
                    <span class="text-2xl font-extrabold text-indigo-900">${count}</span>
                </div>`).join('');
        }

        async function saveAsset(e) {
            e.preventDefault(); if(!checkMgr()) return;
            const fd = new FormData(e.target);
            
            const pDate = new Date(fd.get('purchase_date'));
            const typeCode = TYPE_MAP[fd.get('product_type')] || 'ETC';
            const deptCode = DEPT_MAP[fd.get('dept')] || 'ETC';
            const dateCode = pDate.getFullYear().toString().slice(-2) + MONTH_MAP[pDate.getMonth()];
            const prefix = `${fd.get('cmf_1')}-${typeCode}-${deptCode}-${dateCode}`;
            
            showLoading(true, 'ìì‚° ë“±ë¡ ì¤‘...');
            try {
                const { data: existing } = await supabase.from('MA_PRODUCT').select('cmf_2').ilike('cmf_2', `${prefix}-%`);
                let maxSeq = 0;
                (existing||[]).forEach(r => { try { maxSeq = Math.max(maxSeq, parseInt(r.cmf_2.split('-').pop())); } catch {} });
                const cmf_2 = `${prefix}-${String(maxSeq+1).padStart(4,'0')}`;
                
                const lifeType = fd.get('cmf_3');
                const lifeVal = (lifeType === 'NONE') ? null : fd.get('cmf_4');

                const { error: e1 } = await supabase.from('MA_PRODUCT').insert({
                    product_name: fd.get('product_name'), product_code: fd.get('product_code'),
                    product_type: fd.get('product_type'), cmf_1: fd.get('cmf_1'), cmf_2: cmf_2,
                    purchase_date: fd.get('purchase_date'), qty: parseInt(fd.get('qty')||0),
                    safe_qty: parseInt(fd.get('safe_qty')||0), unit: fd.get('unit'), create_user: state.managerId,
                    cmf_3: lifeType, cmf_4: lifeVal
                });
                if(e1) throw e1;

                const { error: e2 } = await supabase.from('WH_STS').insert({
                    factory_id: fd.get('factory_id'), wh_code: fd.get('wh_code'),
                    product_code: fd.get('product_code'), qty: parseInt(fd.get('qty')||0),
                    safe_qty: parseInt(fd.get('safe_qty')||0), serial_number: fd.get('serial_number') || null,
                    dept: fd.get('dept'), user: fd.get('user'), cmf_1: fd.get('cmf_1'), cmf_2: cmf_2,
                    cmf_3: lifeType, cmf_4: lifeVal
                });
                if(e2) throw new Error('ì¬ê³  ìƒì„± ì‹¤íŒ¨: '+e2.message);

                await supabase.from('LOT_HIS').insert({ 
                    tran_code: 'IN', product_code: fd.get('product_code'), 
                    serial_number: fd.get('serial_number') || null, qty: parseInt(fd.get('qty')||0), 
                    create_user_id: state.managerId 
                });
                
                alertMsg('ìì‚° ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'); 
                $('#asset-modal').classList.add('hidden'); e.target.reset(); resetLifecycleInputs();
            } catch(e) { alertMsg('ì €ì¥ ì‹¤íŒ¨: '+e.message, true); } finally { showLoading(false); }
        }

        async function saveConsumption(e) {
            e.preventDefault(); if(!checkMgr()) return;
            const fd = new FormData(e.target);
            const item = { pCode: fd.get('product_code'), sn: fd.get('serial_number') || null, wh: fd.get('wh_code'), qty: parseInt(fd.get('qty')), tran: fd.get('tran_code') };
            
            if(!item.pCode || !item.wh) { alertMsg('í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.'); return; }

            showLoading(true, 'ì¬ê³  ì²˜ë¦¬ ì¤‘...');
            try {
                let q = supabase.from('WH_STS').select('*').eq('product_code', item.pCode).eq('wh_code', item.wh);
                if(item.sn) q = q.eq('serial_number', item.sn); else q = q.is('serial_number', null);
                
                const { data: stock, error: err1 } = await q.single();
                if(err1 || !stock) throw new Error('í•´ë‹¹ ì¡°ê±´ì˜ ì¬ê³ ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                
                const newQty = item.tran === 'CONSUME' ? stock.qty - item.qty : stock.qty + item.qty;
                if(newQty < 0) throw new Error(`ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í˜„ì¬ê³ : ${stock.qty})`);

                let uq = supabase.from('WH_STS').update({ qty: newQty }).eq('product_code', item.pCode).eq('wh_code', item.wh);
                if(item.sn) uq = uq.eq('serial_number', item.sn); else uq = uq.is('serial_number', null);
                const { error: e2 } = await uq; if(e2) throw e2;
                
                await supabase.from('LOT_HIS').insert({ 
                    tran_code: item.tran, product_code: item.pCode, serial_number: item.sn, 
                    qty: item.qty, create_user_id: state.managerId 
                });
                
                alertMsg('ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'); 
                e.target.reset(); $('#cons-serial').innerHTML = '<option value="">ë¨¼ì € ìì‚° ì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            } catch(e) { alertMsg('ì²˜ë¦¬ ì‹¤íŒ¨: '+e.message, true); } finally { showLoading(false); }
        }

        function checkMgr() { 
            if(!state.managerId) { 
                alertMsg('ì„¤ì • íƒ­ì—ì„œ ê´€ë¦¬ì IDë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.'); 
                changeView('view-settings'); $('#managerIdInput').focus(); return false; 
            } return true; 
        }

        init();
    </script>
</body>
</html>